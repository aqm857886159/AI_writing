# 知识图谱 · 进展与路线图

## 背景与目标
- 写完一个 H2 章节并停笔后，自动从该章节文本抽取“实体-关系”，进行去重合并与筛噪，并以稳定的图形显化（节点不重叠、不卡顿、可增量维护）。

## 已完成（MVP 主干）
- 章节与空闲调度复用：沿用 `SectionDetector` 与文稿快照，知识图谱走独立服务与状态，互不干扰。
- 抽取与合并：
  - GraphRAG 风格强约束 JSON Prompt（实体≤10、5类关系、strength=1–10、同义词写入 description）。
  - 二轮 Gleaning（首轮不足时补遗），合并去重（名称规范化+别名累积），边唯一键 `source->target:type`。
  - 代码：`src/kg/buildKGPrompt.js`、`src/kg/extractWithGleaning.js`、`src/kg/llmAdapter.js`。
- 增量与持久：
  - `src/services/KnowledgeGraphService.js`：以 `section.hash` 为分片的幂等增量；`localStorage` 持久（key: `kg:v0`）。
- 筛选与显化：
  - Top-K+阈值（先用度中心性+`strength>=7`），`src/kg/selectTop.js`。
  - Cytoscape 显化（cose 布局，参数固定避免重叠），`src/components/KnowledgeGraphPanel.jsx`。
- DeepSeek 适配：
  - 优先级：env（`VITE_DEEPSEEK_API_KEY`）→ `window.DEEPSEEK_API_KEY` → `localStorage` → 硬编码；`src/services/DeepseekAdapter.js`。

## 使用与运行条件
- 依赖安装：
```bash
npm i cytoscape
```
- 配置 API Key（任选其一）：
```bash
# .env.local（推荐）
VITE_DEEPSEEK_API_KEY=sk-xxxx

# 或浏览器控制台
localStorage.setItem('DEEPSEEK_API_KEY','sk-xxxx')

# 或在页面注入
window.DEEPSEEK_API_KEY='sk-xxxx'
```
- 写一个 H2 章节并停笔约 20 秒，系统将自动抽取→合并→显化（左侧“批判者”不受影响）。

## 下一步进行中 / 待办（短期）
- 将图指标与布局计算迁入 Web Worker（避免主线程阻塞）。
- 引入 Graphiti 子图 schema 与幂等语义（对齐协议，未来可零成本接后端）。

## 未来改进（Beta → 稳定版）
- 抽取与质量
  - LLM 同义词“极小裁决”以进一步合并近义词。
  - 引入 `graphology`：PageRank/介数 替代单纯度排序。
- 交互与布局
  - 布局切换（cose/dagre）、节点 hover 描述、点击高亮邻接。
  - 社区检测（Louvain）自动分群上色与图例。
- 性能与大图
  - 分层加载/虚拟化；段落↔节点双向定位；导出/导入 `graph.json`。
- 工程与可观测
  - 指标看板：抽取命中率、同义词合并率、渲染耗时。
  - 可选后端路线：沿 Graphiti 协议接“抽取/索引/检索”服务。

## 成功指标（验收线）
- 节点不重叠率 > 95%（布局参数保障）。
- 首屏渲染 < 500ms（Top-K + 禁动画）。
- 实体准确率 > 75%（人工抽检）。
- 同义词合并率 > 80%（抽样评估）。

## 关键文件一览
- 服务与 Hook：
  - `src/services/KnowledgeGraphService.js`（增量/去重/持久/订阅）
  - `src/hooks/useKnowledgeGraph.js`（面板订阅）
- 抽取与 Prompt：
  - `src/kg/buildKGPrompt.js`、`src/kg/llmAdapter.js`、`src/kg/extractWithGleaning.js`
- 选择与显化：
  - `src/kg/selectTop.js`、`src/components/KnowledgeGraphPanel.jsx`
- DeepSeek 适配与 Key：
  - `src/services/DeepseekAdapter.js`

## 设计原则（为什么这么做）
- 强约束 JSON + 二轮 Gleaning：降低 LLM 不稳定性，同时提升召回。
- 名称规范化 + 别名累积：让“一个概念只有一个点”，图更干净。
- Top-K + 阈值先行：优先解决可读性与性能，再逐步加算法。
- 协议先统一：对齐 Graphiti 子图 schema 与幂等语义，前后端一条线。
- Never break userspace：知识图谱与“批判者”解耦，任何一侧出问题不拖累另一侧。

## 参考
- GraphRAG（方法论与 Prompt，MIT）：https://github.com/microsoft/graphrag
- Graphiti（图 RAG 工程化，Apache-2.0）：https://github.com/getzep/graphiti

---
如需新增“回滚到稳定点”的按钮与版本化导出，请在下一里程碑中确认，我将一并落地。


