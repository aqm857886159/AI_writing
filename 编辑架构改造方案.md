## 背景与目标
- **目标**: 让“知识图谱/批判者”对编辑器中的文本变化做到即时、正确、可回收，并具备可运维的手动控制与安全合规。
- **范围**: 文本分章检测、知识图谱抽取与合并、批判者问题生成、LLM 结构化输出自愈、UI 交互与运维、启动环境与密钥安全。

## 现象层（问题表现）
- **图谱陈旧**: 替换/删除文本后，旧节点/边仍保留，或更新迟滞。
- **批判者不产出**: 短文或频繁编辑场景下，迟迟没有问题生成。
- **无 H2 停摆**: 文档没有 H2 标题时，下游逻辑整体不工作。
- **跨文档污染**: 切换新文档后仍带着上一个文档的图谱痕迹。
- **本地启动失败**: Tailwind/PostCSS 报错阻断调试与验证。

## 本质层（根因诊断）
- **只增不减**: `KnowledgeGraphService` 仅合并，不回收已消失章节的贡献。
- **章节标识不稳定**: 章节 `id` 取决于索引顺序，重排/重命名后错配历史状态。
- **触发门槛过高**: `WORDS_MIN=200` 且空闲阈值 `IDLE_MS=20000`，短文/频繁输入几乎不触发。
- **无章节兜底**: 无 H2 时 `detectSections` 返回空，导致后续流程全停。
- **主线程重建布局**: 图谱每次变化重建 Cytoscape，布局在主线程，规模放大后易卡顿。
- **密钥硬编码**: DeepSeek API Key 暴露在前端源码中。

## 哲学层（设计原则）
- **共享即纠缠**: 多章节共享知识须显式维护贡献集合与引用关系，删除需“有的放矢”。
- **信任但要验证**: LLM 输出先本地校验，失败再“AI 自修”，再失败才退化为宽松解析。
- **消除边界优于堆条件**: 无 H2 → 全文即章节；减少分支爆炸，保证系统总有输出。
- **永不破坏用户空间**: 切换文档/大改动时可从零开始或自动回收，避免污染。

## 解决方案总览（最小闭环）
- **分章兜底**: 无 H2 时将全文视作单一“正文章节”。
- **可回收图谱**: 按“章节内容哈希”追踪每轮抽取贡献（节点、边），当章节消失或内容变更时回收对应贡献；同时保留仍被其它章节引用的知识。
- **批判者更友好**: 放宽门槛（默认字数约 ≥80，空闲约 ≥8s，均可通过 `localStorage` 配置），短文兜底至少 1 条 Q/Why；提供“立即生成”按钮。
- **运维通道**: 图谱面板增加“一键清空”按钮，切文档时可从零开始。
- **安全合规**: 移除前端硬编码密钥，统一使用 `.env.local`/`window`/`localStorage` 注入。
- **启动修复**: 使用 `@tailwindcss/postcss` 与 `lightningcss` 修复本地构建。

## 关键代码改动摘要（按文件）
- `src/services/SectionDetector.js`
  - 无 H2 → 全文即章节的兜底策略，消除“无输出”边界情况。
- `src/services/KnowledgeGraphService.js`
  - 新增 `contribByHash` 记录每个章节哈希贡献的 `nodeKeys`/`edgeKeys`。
  - `removeContrib(hash)`/重算保留集，实现章节删除/替换的差分回收。
  - 暴露 `resetGraph()` 便于一键清空图谱与元信息。
- `src/services/CriticService.js`
  - 将 `WORDS_MIN`、`IDLE_MS` 降至更温和默认（支持本地覆盖）。
  - 加入短文兜底 1 条 Q/Why；导出 `refreshSection(sectionId)` 实现“立即生成”。
- `src/components/CriticPanel.jsx`
  - 章节卡片新增“立即生成”按钮，显式触发该章批判生成。
- `src/components/KnowledgeGraphPanel.jsx`
  - 工具条新增“清空图谱”按钮，调用 `resetGraph()`。
- `src/services/DeepseekAdapter.js`
  - 移除硬编码 API Key，仅保留从环境/窗口/localStorage 注入。
- `postcss.config.js` + 依赖
  - 使用 `@tailwindcss/postcss` 并安装 `lightningcss` 解决本地报错。

## AI 增强工作流（结构化自愈与共识）
- **自检-自修**: `askKGExtractRaw` 增加 JSON Schema 校验，失败后触发一次“AI 修复 JSON”再校验；仍失败则回落到轻格式（Q/Why）与自由文本切句的既有兜底。
- **一致性复核**: 对低强度（`strength<5`）关系进行二次复核（低温度/改写提示），两轮一致才入库（可按需启用）。
- **语义去重**: 通过在实体 `description` 中写入“别名: …”来做别名合并；对可疑同名实体可做一次“是否同一实体”的判定调用。
- **不确定性可视化**: UI 标注低强度/低置信条目，提供“一键复核/忽略”，并把用户决策写回别名映射，形成“人机共识”。

## 触发与调度策略
- **编辑事件 → 防抖（~1200ms） → 空闲阈值（默认 8s） → 任务入队（并发 1–2） → LLM 抽取/自愈 → 规范化合并 → 写入章节哈希贡献 → 通知 UI → （可选）Worker 布局**。
- **批判者**: 章节状态 `dormant → pending → ready`；短文兜底 1 条；可随时手动“立即生成”。

## 运维与安全
- **清空图谱**: `resetGraph()` 清除图谱、章节元信息与贡献集。
- **阈值热调**: `localStorage.setItem('critic:idleMs','8000')`、`localStorage.setItem('critic:wordsMin','80')`。
- **密钥管理**: `.env.local` 中设置 `VITE_DEEPSEEK_API_KEY=...`（不入库），或运行时通过 `window.DEEPSEEK_API_KEY`/`localStorage['DEEPSEEK_API_KEY']` 注入。

## 启动环境修复
- 安装依赖：
```bash
npm i -D @tailwindcss/postcss postcss tailwindcss lightningcss
```
- `postcss.config.js`：
```js
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
    autoprefixer: {},
  },
};
```
- `.env.local`：
```bash
VITE_DEEPSEEK_API_KEY=sk-xxxx
```

## 验收清单（自测手册）
- 无 H2（纯正文）仍能生成图谱与批判者问题。
- 新增/替换/删除章节：图谱随之更新且回收旧知识；被其它章节复用的知识不误删。
- 短文（50–150 字）至少产出 1 条 Q/Why。
- 跨文档切换：“清空图谱”后新文档从零开始，无污染。
- 大文本（>10k 字）下仍能在合理时间内完成抽取与渲染；需要时可延后布局或迁移到 Worker。

## 后续演进（第二阶段）
- **Worker 布局**: 将 Cytoscape 布局搬至 Web Worker 或采用 ELK.js；大图下显著降卡顿。
- **稳定章节 ID**: 通过 TipTap Heading 扩展 `data-section-id` 或 Yjs 锚点维护“标题→ID”映射，实现跨重排稳定引用。
- **增量抽取**: 利用 ProseMirror steps（如 `prosemirror-changeset`）对受影响子树做增量抽取，进一步削减调用成本。
- **更严 schema**: 若上游支持 JSON Schema/函数调用，前端校验可直接按 schema 严格验收。

## 小结
- 用“章节哈希→贡献追踪→差异回收”解决图谱陈旧与污染的根因。
- 用“全文兜底章节”消除最大边界情况，保证系统“总有输出”。
- 用“阈值温和+手动触发+短文兜底”确保批判者稳定产出。
- 用“自检-自修-共识”的 AI 工作流提升结构化质量与用户掌控感。
- 完成上述改造后，建议打稳定 tag 并推送 GitHub，作为回滚锚点。
